/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a public-read model for restaurants and their associated data.
 *  It allows anonymous users to create orders, and allows anyone to view the list of orders for the admin panel.
 *
 * Data Structure:
 * - /restaurants/{restaurantId}: Restaurant details (public read, admin write).
 * - /restaurants/{restaurantId}/menuCategories/{menuCategoryId}: Menu categories (public read, admin write).
 * - /restaurants/{restaurantId}/menuCategories/{menuCategoryId}/menuItems/{menuItemId}: Menu items (public read, admin write).
 * - /restaurants/{restaurantId}/orders/{orderId}: Orders for a restaurant.
 * - /restaurants/{restaurantId}/orders/{orderId}/orderItems/{orderItemId}: Items within an order.
 * - /restaurants/{restaurantId}/tables/{tableId}: Table information with QR codes (public read, admin write).
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read restaurant data, but restricts writes.
     * @path /restaurants/{restaurantId}
     */
    match /restaurants/{restaurantId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();

        /**
         * @description Allows anyone to read menu category data, but restricts writes to authenticated users.
         * @path /restaurants/{restaurantId}/menuCategories/{menuCategoryId}
         */
        match /menuCategories/{menuCategoryId} {
          allow get, list: if true;
          allow create, update, delete: if isSignedIn();

          /**
           * @description Allows anyone to read menu item data, but restricts writes to authenticated users.
           * @path /restaurants/{restaurantId}/menuCategories/{menuCategoryId}/menuItems/{menuItemId}
           */
          match /menuItems/{menuItemId} {
            allow get, list: if true;
            allow create, update, delete: if isSignedIn();
          }
        }

        /**
         * @description Publicly readable orders, but write access is restricted.
         * @path /restaurants/{restaurantId}/orders
         */
        match /orders/{orderId} {
          allow get: if true;
          allow list: if true; // Allow public list access for the admin panel
          allow create: if isSignedIn(); // Allow any signed-in user (including anonymous) to create orders
          allow update, delete: if isAdmin(); // Only admin can update or delete
          
          /**
           * @description Allows read access to order items, but restricts writes.
           * @path /restaurants/{restaurantId}/orders/{orderId}/orderItems/{orderItemId}
           */
          match /orderItems/{orderItemId} {
            allow get, list: if true;
            allow create: if isSignedIn();
            allow update, delete: if isAdmin();
          }
        }

        /**
         * @description Allows anyone to read table data, but restricts writes to authenticated users.
         * @path /restaurants/{restaurantId}/tables/{tableId}
         */
        match /tables/{tableId} {
          allow get, list: if true;
          allow create, update, delete: if isSignedIn();
        }
    }


    /**
     * @description Checks if the user is signed in. This can be an anonymous user.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * @description Checks if the user is an admin.
     * @return {boolean} True if the user's email is the admin email, false otherwise.
     */
    function isAdmin() {
      return request.auth != null && request.auth.token.email == "admin@tablebites.com";
    }
  }
}
