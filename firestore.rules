rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null && request.auth.token.email == "admin@tablebites.com";
    }

    match /restaurants/{restaurantId} {
      // Rules for parent restaurant document (if any were needed) would go here.
      // e.g. allow read: if true;

      // Rules for the 'orders' subcollection
      match /orders/{orderId} {
        // ALLOW an admin to LIST (query) the 'orders' collection.
        // This is the key rule that fixes the "Missing or insufficient permissions" error.
        allow list: if isAdmin();

        // ALLOW an admin to GET a single order document.
        allow get: if isAdmin();

        // ALLOW any authenticated user (including anonymous) to CREATE an order.
        allow create: if request.auth != null;

        // ALLOW an admin to UPDATE or DELETE a single order document.
        allow update, delete: if isAdmin();

        // Rules for the 'orderItems' sub-subcollection
        match /orderItems/{orderItemId} {
            allow read, write: if isAdmin();
        }
      }
    }
  }
}
