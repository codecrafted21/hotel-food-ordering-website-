rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is the designated admin.
    function isAdmin() {
      // This rule grants admin access only to a specific, hardcoded UID.
      return request.auth.uid == 'WUmZIHmue2XXVB38hTCT8hyAWQD3';
    }

    // Public read access for restaurant data, menus, and tables.
    match /restaurants/{restaurantId} {
      allow get: if true;

      // Allow admin to write to restaurant data, menus, and tables
      allow write: if isAdmin();

      match /menuCategories/{menuCategoryId} {
        allow get: if true;
        allow write: if isAdmin();
        match /menuItems/{menuItemId} {
            allow get: if true;
            allow write: if isAdmin();
        }
      }
      
      match /tables/{tableId} {
          allow get: if true;
          allow write: if isAdmin();
      }

      match /dishes/{dishId} {
        allow read, write: if isAdmin();
      }

      // Rules for the 'orders' subcollection.
      match /orders/{orderId} {
        // Any authenticated user can create an order for themselves.
        // We use request.auth.uid to ensure the order is linked to the user creating it.
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        
        // Admins can list all orders for their dashboard.
        // Customers can only read their own specific order, not list all of them.
        allow list: if isAdmin();
        allow get: if (request.auth != null && resource.data.userId == request.auth.uid) || isAdmin();
        
        // Admins can update the status of any order.
        allow update: if isAdmin();

        // Rules for the 'orderItems' sub-subcollection.
        match /orderItems/{orderItemId} {
            // Allow creation of order items if the user is the owner of the parent order.
            allow create: if request.auth != null && get(/databases/$(database)/documents/restaurants/$(restaurantId)/orders/$(orderId)).data.userId == request.auth.uid;
            
            // Allow reading of order items for the order owner or an admin.
            allow read: if (request.auth != null && get(/databases/$(database)/documents/restaurants/$(restaurantId)/orders/$(orderId)).data.userId == request.auth.uid) || isAdmin();
        }
      }
    }
  }
}
